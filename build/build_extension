#!/usr/bin/python3

################################################################################
#                                                                              #
#                     B U I L D   A N   E X T E N S I O N                      #
#                                                                              #
#   Build an extension for the Generalized Formatting System                   #
#                                                                              #
#   USAGE:                                                                     #
#      ./build_extension <source directory> <extension file> <output file>     #
#                                                                              #
#      <source directory>   : location of the GFS main code.                   #
#      <extension file>     : the file to be compiled.                         #
#      <output file>        : the location of the output executable            #
#                                                                              #
################################################################################

import os
import shutil
import subprocess
import sys
import tempfile

#
# G E T   C O M M A N D   L I N E   A R G U M E N T S
#

if len(sys.argv) != 4:
	raise Exception("INVALID!\nUsage: <src> <ext> <out>")

srcdir = os.path.abspath(sys.argv[1])
extfil = os.path.abspath(sys.argv[2])
outfil = os.path.abspath(sys.argv[3])

#
# P U T  S O U R C E   I N T O   D I R E C T O R Y
#

#Create a temporary directory
tmpdir = tempfile.TemporaryDirectory()
dir = tmpdir.name

#Include files
idir = os.path.join(dir, "gfs/")
os.mkdir(idir)

#Copy the files
for f in os.listdir(srcdir):
	shutil.copyfile(os.path.join(srcdir, f), os.path.join(idir, f))

#Go to the temp directory for the compilation step
os.chdir(dir)

#
# C O M P I L E
#

subprocess.run(["gcc", "-fPIC", "-I"+dir, "-shared", "-o", outfil, extfil])
